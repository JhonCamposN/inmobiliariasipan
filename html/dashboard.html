<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrativo - Sipán Inmobiliaria</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header del Dashboard -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="logo-dashboard">
                    <i class="fas fa-building"></i>
                    <h1>Sipán Inmobiliaria</h1>
                    <span class="dashboard-title">Panel Administrativo</span>
                </div>
                <div class="header-actions">
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i>
                        <span>Administrador</span>
                    </div>
                    <button class="btn-logout" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Cerrar Sesión
                    </button>
                </div>
            </div>
        </header>

        <!-- Navegación del Dashboard -->
        <nav class="dashboard-nav">
            <button class="nav-btn active" onclick="showSection('calificaciones')">
                <i class="fas fa-star"></i>
                Calificaciones
            </button>
            <button class="nav-btn" onclick="showSection('solicitudes')">
                <i class="fas fa-envelope"></i>
                Solicitudes de Asesoría
            </button>
            <button class="nav-btn" onclick="showSection('estadisticas')">
                <i class="fas fa-chart-bar"></i>
                Estadísticas
            </button>
        </nav>

        <!-- Contenido Principal -->
        <main class="dashboard-main">
            <!-- Sección de Calificaciones -->
            <section id="calificaciones" class="dashboard-section active">
                <div class="section-header">
                    <div class="section-title">
                        <h2><i class="fas fa-star"></i> Calificaciones de la Página</h2>
                        <button class="btn-export" onclick="exportarCalificacionesExcel()">
                            <i class="fas fa-file-excel"></i>
                            <span>Exportar a Excel</span>
                        </button>
                    </div>
                    <div class="stats-summary">
                        <div class="stat-card">
                            <div class="stat-number" id="promedioCalificaciones">-</div>
                            <div class="stat-label">Promedio</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalCalificaciones">-</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>
                </div>

                <!-- Filtros para Calificaciones -->
                <div class="filters-section">
                    <div class="filters-container">
                        <div class="filter-group">
                            <label for="filtroOrden">Ordenar por:</label>
                            <select id="filtroOrden" onchange="aplicarFiltros()">
                                <option value="mas-reciente">Más reciente</option>
                                <option value="mas-antiguo">Más antiguo</option>
                                <option value="mejor-valorado">Mejor valorado</option>
                                <option value="menor-valorado">Menor valorado</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filtroEstrellas">Filtrar por estrellas:</label>
                            <select id="filtroEstrellas" onchange="aplicarFiltros()">
                                <option value="todas">Todas las calificaciones</option>
                                <option value="5">5 estrellas</option>
                                <option value="4">4 estrellas</option>
                                <option value="3">3 estrellas</option>
                                <option value="2">2 estrellas</option>
                                <option value="1">1 estrella</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filtroEstado">Estado:</label>
                            <select id="filtroEstado" onchange="aplicarFiltros()">
                                <option value="todos">Todos los registros</option>
                                <option value="activos">Solo activos</option>
                                <option value="ocultos">Solo ocultos</option>
                            </select>
                        </div>
                        <button class="btn-reset-filters" onclick="resetearFiltros()">
                            <i class="fas fa-undo"></i>
                            Limpiar Filtros
                        </button>
                    </div>
                </div>

                <!-- Paginación Superior -->
                <div class="pagination-container" id="paginacionSuperior">
                    <!-- Se genera dinámicamente -->
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Calificación</th>
                                <th>Comentario</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="calificacionesTable">
                            <!-- Los datos se cargarán dinámicamente desde la base de datos -->
                        </tbody>
                    </table>
                </div>

                <!-- Paginación Inferior -->
                <div class="pagination-container" id="paginacionInferior">
                    <!-- Se genera dinámicamente -->
                </div>
            </section>

            <!-- Sección de Solicitudes -->
            <section id="solicitudes" class="dashboard-section">
                <div class="section-header">
                    <div class="section-title">
                        <h2><i class="fas fa-envelope"></i> Solicitudes de Asesoría</h2>
                        <button class="btn-export" onclick="exportarContactosExcel()">
                            <i class="fas fa-file-excel"></i>
                            <span>Exportar a Excel</span>
                        </button>
                    </div>
                    <div class="stats-summary">
                        <div class="stat-card">
                            <div class="stat-number" id="pendientesCount">-</div>
                            <div class="stat-label">Pendientes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalContactos">-</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>
                </div>

                <!-- Filtros para Solicitudes -->
                <div class="filters-section">
                    <div class="filters-container">
                        <div class="filter-group">
                            <label for="estadoFilterSolicitudes">Estado:</label>
                            <select id="estadoFilterSolicitudes" onchange="aplicarFiltrosSolicitudes()">
                                <option value="todos">Todos</option>
                                <option value="pendiente">Solo Pendientes</option>
                                <option value="atendido">Solo Atendidos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="visibilidadFilterSolicitudes">Visibilidad:</label>
                            <select id="visibilidadFilterSolicitudes" onchange="aplicarFiltrosSolicitudes()">
                                <option value="todos">Todos</option>
                                <option value="activo">Solo Activos</option>
                                <option value="oculto">Solo Ocultos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="ordenFilterSolicitudes">Ordenar por:</label>
                            <select id="ordenFilterSolicitudes" onchange="aplicarFiltrosSolicitudes()">
                                <option value="reciente">Más Reciente</option>
                                <option value="antiguo">Más Antiguo</option>
                            </select>
                        </div>
                        <button class="btn-reset-filters" onclick="limpiarFiltrosSolicitudes()">
                            <i class="fas fa-undo"></i>
                            Limpiar Filtros
                        </button>
                    </div>
                </div>

                <!-- Paginación Superior -->
                <div class="pagination-container" id="paginacionSuperiorSolicitudes">
                    <!-- Se generará dinámicamente -->
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>DNI</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="solicitudesTable">
                            <!-- Los datos se cargarán dinámicamente desde la base de datos -->
                        </tbody>
                    </table>
                </div>

                <!-- Paginación Inferior -->
                <div class="pagination-container" id="paginacionInferiorSolicitudes">
                    <!-- Se generará dinámicamente -->
                </div>
            </section>

            <!-- Sección de Estadísticas -->
            <section id="estadisticas" class="dashboard-section">
                <div class="section-header">
                    <h2><i class="fas fa-chart-bar"></i> Estadísticas Generales</h2>
                </div>

                <div class="stats-grid">

                    <div class="stat-card-large">
                        <div class="stat-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number" id="solicitudesTotalesGeneral">-</div>
                            <div class="stat-label">Solicitudes Totales</div>
                            <div class="stat-change positive" id="solicitudesChange">Cargando...</div>
                        </div>
                    </div>

                    <div class="stat-card-large">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number" id="calificacionPromedioGeneral">-</div>
                            <div class="stat-label">Calificación Promedio</div>
                            <div class="stat-change positive" id="calificacionChange">Cargando...</div>
                        </div>
                    </div>

                </div>
            </section>
        </main>
    </div>

    <!-- Modal para detalles de calificación -->
    <!-- Modal para detalles de calificación -->
    <div id="modalCalificacion" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3><i class="fas fa-star"></i> Detalles de la Calificación</h3>
                <button class="modal-close" onclick="cerrarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="calificacion-detalle">
                    <div class="cliente-info">
                        <div class="avatar-placeholder">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="cliente-datos">
                            <h4 id="modalNombreCliente">-</h4>
                            <p id="modalEmailCliente">-</p>
                            <span class="fecha-calificacion" id="modalFechaCalificacion">-</span>
                        </div>
                    </div>
                    
                    <div class="rating-display">
                        <div class="rating-stars" id="modalEstrellas">
                            <!-- Estrellas se generarán dinámicamente -->
                        </div>
                        <span class="rating-number" id="modalNumeroCalificacion">-</span>
                    </div>
                    
                    <div class="comentario-section">
                        <h5><i class="fas fa-comment"></i> Comentario del Cliente</h5>
                        <div class="comentario-texto" id="modalComentario">
                            <!-- Comentario se cargará dinámicamente -->
                        </div>
                    </div>
                    
                    <!-- Sección para mensaje de asesoría (oculta por defecto) -->
                    <div class="mensaje-section-sipan" id="modalMensajeSection" style="display: none;">
                        <div class="mensaje-header-sipan">
                            <div class="mensaje-icon-sipan">
                                <i class="fas fa-envelope-open-text"></i>
                            </div>
                            <div class="mensaje-title-sipan">
                                <h4>Solicitud de Asesoría Inmobiliaria</h4>
                                <p>Mensaje enviado por el cliente</p>
                            </div>
                            <div class="sipan-badge">
                                <i class="fas fa-building"></i>
                                <span>Sipán</span>
                            </div>
                        </div>
                        <div class="mensaje-content-sipan">
                            <div class="datos-cliente-sipan">
                                <div class="dato-item-sipan">
                                    <span class="dato-label">Nombre:</span>
                                    <span class="dato-valor" id="modalNombreAsesoria">-</span>
                                </div>
                                <div class="dato-item-sipan">
                                    <span class="dato-label">Correo:</span>
                                    <span class="dato-valor" id="modalCorreoAsesoria">-</span>
                                </div>
                                <div class="dato-item-sipan">
                                    <span class="dato-label">Teléfono:</span>
                                    <span class="dato-valor" id="modalTelefonoAsesoria">-</span>
                                </div>
                                <div class="dato-item-sipan">
                                    <span class="dato-label">DNI:</span>
                                    <span class="dato-valor" id="modalDniAsesoria">-</span>
                                </div>
                                <div class="dato-item-sipan">
                                    <span class="dato-label">Tipo de consulta:</span>
                                    <span class="dato-valor" id="modalTipoConsulta">-</span>
                                </div>
                            </div>
                            
                            <div class="mensaje-quote-sipan">
                                <div class="quote-icon">
                                    <i class="fas fa-quote-left"></i>
                                </div>
                                <div class="mensaje-label-sipan">Mensaje:</div>
                                <div class="mensaje-texto-sipan" id="modalMensaje">
                                    <!-- Mensaje se cargará dinámicamente -->
                                </div>
                                <div class="quote-decoration"></div>
                            </div>
                        </div>
                        <div class="mensaje-footer-sipan">
                            <div class="footer-info">
                                <i class="fas fa-handshake"></i>
                                <span>Corporación Inmobiliaria Sipán - Comprometidos con tu futuro</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metadata-section">
                        <div class="metadata-item">
                            <i class="fas fa-globe"></i>
                            <span>IP: <span id="modalIP">-</span></span>
                        </div>
                        <div class="metadata-item">
                            <i class="fas fa-clock"></i>
                            <span>Fecha completa: <span id="modalFechaCompleta">-</span></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal()">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Pop-up de éxito para exportación -->
    <div id="successPopup" class="success-popup">
        <div class="success-content">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="success-title">¡Exportación Exitosa!</h3>
            <p class="success-message" id="successMessage">El archivo Excel se ha descargado correctamente</p>
            <div class="success-progress">
                <div class="progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Eliminación -->
    <div id="modalEliminar" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación</h3>
                <button class="modal-close" onclick="cerrarModalEliminar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>¿Qué acción deseas realizar con este registro?</p>
                <div class="elimination-options">
                    <div class="option-card logical">
                        <div class="option-icon">
                            <i class="fas fa-eye-slash"></i>
                        </div>
                        <div class="option-content">
                            <h4>Ocultar Registro</h4>
                            <p>El registro se ocultará pero permanecerá en la base de datos (eliminación lógica)</p>
                        </div>
                        <button class="btn-option logical" onclick="eliminarRegistro('logica')">
                            <i class="fas fa-eye-slash"></i> Ocultar
                        </button>
                    </div>
                    <div class="option-card permanent">
                        <div class="option-icon">
                            <i class="fas fa-trash-alt"></i>
                        </div>
                        <div class="option-content">
                            <h4>Eliminar Permanentemente</h4>
                            <p>El registro será eliminado completamente de la base de datos (no se puede recuperar)</p>
                        </div>
                        <button class="btn-option permanent" onclick="eliminarRegistro('permanente')">
                            <i class="fas fa-trash-alt"></i> Eliminar
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="cerrarModalEliminar()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Verificar autenticación
        if (!localStorage.getItem('isLoggedIn')) {
            window.location.href = 'login.html';
        }

        // Cargar datos al iniciar la página
        document.addEventListener('DOMContentLoaded', function() {
            cargarContactos();
            cargarEstadisticasContactos();
            cargarEstadisticasGenerales();
            cargarCalificaciones();
            cargarEstadisticasCalificaciones();
        });

        function showSection(sectionName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remover clase active de botones
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar sección seleccionada
            document.getElementById(sectionName).classList.add('active');
            
            // Activar botón correspondiente
            event.target.classList.add('active');
            
            // Cargar datos específicos de la sección
            if (sectionName === 'solicitudes') {
                cargarContactos();
                cargarEstadisticasContactos();
            } else if (sectionName === 'estadisticas') {
                cargarEstadisticasGenerales();
            } else if (sectionName === 'calificaciones') {
                cargarCalificaciones();
                cargarEstadisticasCalificaciones();
            }
        }

        async function cargarContactos() {
            try {
                const response = await fetch('../php/contactos-api.php?action=contactos');
                const data = await response.json();
                
                if (data.success) {
                    solicitudesCompletas = data.data || [];
                    aplicarFiltrosSolicitudes();
                } else {
                    console.error('Error al cargar contactos:', data.error);
                }
            } catch (error) {
                console.error('Error de conexión:', error);
            }
        }

        async function cargarEstadisticasContactos() {
            try {
                const response = await fetch('../php/contactos-api.php?action=estadisticas');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('pendientesCount').textContent = data.data.pendientes;
                    document.getElementById('totalContactos').textContent = data.data.total;
                } else {
                    console.error('Error al cargar estadísticas:', data.error);
                }
            } catch (error) {
                console.error('Error de conexión:', error);
            }
        }

        async function cargarEstadisticasGenerales() {
            try {
                // Cargar estadísticas de contactos
                const responseContactos = await fetch('../php/contactos-api.php?action=estadisticas');
                const dataContactos = await responseContactos.json();
                
                // Cargar estadísticas de calificaciones
                const responseCalificaciones = await fetch('../php/calificaciones-api.php?accion=estadisticas');
                const dataCalificaciones = await responseCalificaciones.json();
                
                if (dataContactos.success) {
                    document.getElementById('solicitudesTotalesGeneral').textContent = dataContactos.data.total;
                    
                    // Calcular cambio porcentual (simulado por ahora)
                    const cambioSolicitudes = dataContactos.data.este_mes > 0 ? `+${Math.round((dataContactos.data.este_mes / dataContactos.data.total) * 100)}% este mes` : 'Sin datos del mes';
                    document.getElementById('solicitudesChange').textContent = cambioSolicitudes;
                }
                
                if (dataCalificaciones.success) {
                    const promedio = parseFloat(dataCalificaciones.data.promedio_calificacion).toFixed(1);
                    document.getElementById('calificacionPromedioGeneral').textContent = promedio;
                    
                    // Mostrar satisfacción como cambio
                    const satisfaccion = parseFloat(dataCalificaciones.data.porcentaje_satisfechos).toFixed(0);
                    document.getElementById('calificacionChange').textContent = `${satisfaccion}% satisfacción`;
                }
                
            } catch (error) {
                console.error('Error al cargar estadísticas generales:', error);
                document.getElementById('solicitudesTotalesGeneral').textContent = 'Error';
                document.getElementById('calificacionPromedioGeneral').textContent = 'Error';
                document.getElementById('solicitudesChange').textContent = 'Error al cargar';
                document.getElementById('calificacionChange').textContent = 'Error al cargar';
            }
        }

        function mostrarContactos(contactos) {
            const tbody = document.getElementById('solicitudesTable');
            tbody.innerHTML = '';
            
            if (contactos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No hay solicitudes registradas</td></tr>';
                return;
            }
            
            contactos.forEach(contacto => {
                const tr = document.createElement('tr');
                const estadoClass = contacto.estado === 'pendiente' ? 'pending' : 'completed';
                const estadoTexto = contacto.estado === 'pendiente' ? 'Pendiente' : 'Atendida';
                
                // Agregar clase para registros ocultos
                if (contacto.activo == 0) {
                    tr.classList.add('registro-oculto');
                }
                
                tr.innerHTML = `
                    <td>${contacto.fecha_formateada}</td>
                    <td>${contacto.nombre}</td>
                    <td>${contacto.dni || 'N/A'}</td>
                    <td>${contacto.email}</td>
                    <td>${contacto.telefono || 'N/A'}</td>
                    <td class="${estadoClass}">${estadoTexto}</td>
                    <td>
                        <button class="btn-action view" onclick="viewDetails('sol', ${contacto.id})"><i class="fas fa-eye"></i></button>
                        ${contacto.estado === 'pendiente' && contacto.activo == 1 ? 
                            `<button class="btn-action complete check-btn" onclick="markComplete(${contacto.id})">
                                <i class="fas fa-check"></i>
                            </button>` : 
                            contacto.estado === 'atendido' && contacto.activo == 1 ?
                            `<button class="btn-action cancel cancel-btn" onclick="revertirEstado(${contacto.id})" title="Revertir a pendiente">
                                <i class="fas fa-times"></i>
                            </button>` : ''
                        }
                        ${contacto.activo == 1 ? 
                            `<button class="btn-action delete" onclick="mostrarModalEliminar('contacto', ${contacto.id})">
                                <i class="fas fa-trash"></i>
                            </button>` : 
                            `<button class="btn-action restore" onclick="restaurarRegistro('contacto', ${contacto.id})" title="Restaurar registro">
                                <i class="fas fa-undo"></i>
                            </button>`
                        }
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Funciones para filtros y paginación de solicitudes
        function aplicarFiltrosSolicitudes() {
            const estadoFilter = document.getElementById('estadoFilterSolicitudes').value;
            const visibilidadFilter = document.getElementById('visibilidadFilterSolicitudes').value;
            const ordenFilter = document.getElementById('ordenFilterSolicitudes').value;
            
            // Aplicar filtros
            solicitudesFiltradas = solicitudesCompletas.filter(solicitud => {
                let cumpleEstado = true;
                let cumpleVisibilidad = true;
                
                // Filtro por estado
                if (estadoFilter !== 'todos') {
                    cumpleEstado = solicitud.estado === estadoFilter;
                }
                
                // Filtro por visibilidad
                if (visibilidadFilter !== 'todos') {
                    if (visibilidadFilter === 'activo') {
                        cumpleVisibilidad = solicitud.activo == 1;
                    } else if (visibilidadFilter === 'oculto') {
                        cumpleVisibilidad = solicitud.activo == 0;
                    }
                }
                
                return cumpleEstado && cumpleVisibilidad;
            });
            
            // Aplicar ordenamiento
            if (ordenFilter === 'reciente') {
                solicitudesFiltradas.sort((a, b) => {
                    const fechaA = new Date(a.fecha_creacion);
                    const fechaB = new Date(b.fecha_creacion);
                    return fechaB - fechaA;
                });
            } else if (ordenFilter === 'antiguo') {
                solicitudesFiltradas.sort((a, b) => {
                    const fechaA = new Date(a.fecha_creacion);
                    const fechaB = new Date(b.fecha_creacion);
                    return fechaA - fechaB;
                });
            }
            
            // Resetear página actual
            paginaActualSolicitudes = 1;
            
            // Mostrar resultados paginados
            mostrarSolicitudesPaginadas();
            actualizarPaginacionSolicitudes();
        }
        
        function mostrarSolicitudesPaginadas() {
            const inicio = (paginaActualSolicitudes - 1) * registrosPorPaginaSolicitudes;
            const fin = inicio + registrosPorPaginaSolicitudes;
            const solicitudesPagina = solicitudesFiltradas.slice(inicio, fin);
            
            mostrarContactos(solicitudesPagina);
        }
        
        function actualizarPaginacionSolicitudes() {
            const totalPaginas = Math.ceil(solicitudesFiltradas.length / registrosPorPaginaSolicitudes);
            const paginacionSuperior = document.getElementById('paginacionSuperiorSolicitudes');
            const paginacionInferior = document.getElementById('paginacionInferiorSolicitudes');
            
            const htmlPaginacion = generarHtmlPaginacionSolicitudes(totalPaginas);
            
            paginacionSuperior.innerHTML = htmlPaginacion;
            paginacionInferior.innerHTML = htmlPaginacion;
        }
        
        function generarHtmlPaginacionSolicitudes(totalPaginas) {
            if (totalPaginas <= 1) return '';
            
            let html = '<div class="pagination-controls">';
            
            // Botón anterior
            html += `<button class="btn-pagination ${paginaActualSolicitudes === 1 ? 'disabled' : ''}" 
                     onclick="cambiarPaginaSolicitudes(${paginaActualSolicitudes - 1})" 
                     ${paginaActualSolicitudes === 1 ? 'disabled' : ''}>
                        <i class="fas fa-chevron-left"></i> Anterior
                     </button>`;
            
            // Números de página
            const maxBotones = 5;
            let inicioPag = Math.max(1, paginaActualSolicitudes - Math.floor(maxBotones / 2));
            let finPag = Math.min(totalPaginas, inicioPag + maxBotones - 1);
            
            if (finPag - inicioPag < maxBotones - 1) {
                inicioPag = Math.max(1, finPag - maxBotones + 1);
            }
            
            if (inicioPag > 1) {
                html += `<button class="btn-pagination-number" onclick="cambiarPaginaSolicitudes(1)">1</button>`;
                if (inicioPag > 2) {
                    html += '<span class="pagination-dots">...</span>';
                }
            }
            
            for (let i = inicioPag; i <= finPag; i++) {
                html += `<button class="btn-pagination-number ${i === paginaActualSolicitudes ? 'active' : ''}" 
                         onclick="cambiarPaginaSolicitudes(${i})">${i}</button>`;
            }
            
            if (finPag < totalPaginas) {
                if (finPag < totalPaginas - 1) {
                    html += '<span class="pagination-dots">...</span>';
                }
                html += `<button class="btn-pagination-number" onclick="cambiarPaginaSolicitudes(${totalPaginas})">${totalPaginas}</button>`;
            }
            
            // Botón siguiente
            html += `<button class="btn-pagination ${paginaActualSolicitudes === totalPaginas ? 'disabled' : ''}" 
                     onclick="cambiarPaginaSolicitudes(${paginaActualSolicitudes + 1})" 
                     ${paginaActualSolicitudes === totalPaginas ? 'disabled' : ''}>
                        Siguiente <i class="fas fa-chevron-right"></i>
                     </button>`;
            
            html += '</div>';
            
            // Información de registros
            const inicioInfo = (paginaActualSolicitudes - 1) * registrosPorPaginaSolicitudes + 1;
            const finInfo = Math.min(paginaActualSolicitudes * registrosPorPaginaSolicitudes, solicitudesFiltradas.length);
            
            html += `<div class="pagination-info">
                        Mostrando ${inicioInfo} - ${finInfo} de ${solicitudesFiltradas.length} solicitudes
                     </div>`;
            
            return html;
        }
        
        function cambiarPaginaSolicitudes(nuevaPagina) {
            const totalPaginas = Math.ceil(solicitudesFiltradas.length / registrosPorPaginaSolicitudes);
            
            if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
                paginaActualSolicitudes = nuevaPagina;
                mostrarSolicitudesPaginadas();
                actualizarPaginacionSolicitudes();
            }
        }
        
        function limpiarFiltrosSolicitudes() {
            document.getElementById('estadoFilterSolicitudes').value = 'todos';
            document.getElementById('visibilidadFilterSolicitudes').value = 'todos';
            document.getElementById('ordenFilterSolicitudes').value = 'reciente';
            aplicarFiltrosSolicitudes();
        }

        function logout() {
            localStorage.removeItem('isLoggedIn');
            window.location.href = 'login.html';
        }

        function viewDetails(type, id, mensaje = '') {
            console.log('viewDetails llamado:', type, id);
            console.log('Tipo de parámetros:', typeof type, typeof id);
            if (type === 'sol') {
                console.log('Entrando en lógica de solicitud');
                // Buscar datos del contacto en los datos cargados
                let contacto = null;
                let mensajeReal = '';
                
                // Buscar en solicitudesFiltradas primero
                console.log('solicitudesFiltradas:', window.solicitudesFiltradas);
                console.log('solicitudesCompletas:', window.solicitudesCompletas);
                
                if (window.solicitudesFiltradas) {
                    contacto = window.solicitudesFiltradas.find(c => c.id == id);
                    console.log('Búsqueda en filtradas:', contacto);
                }
                
                // Si no se encuentra, buscar en solicitudesCompletas
                if (!contacto && window.solicitudesCompletas) {
                    contacto = window.solicitudesCompletas.find(c => c.id == id);
                    console.log('Búsqueda en completas:', contacto);
                }
                
                // Fallback: buscar directamente en la API
                if (!contacto) {
                    console.log('Buscando directamente en la API...');
                    // Hacer una consulta directa a la API para obtener el contacto
                    fetch(`../php/contactos-api.php?action=contactos`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const contactoEncontrado = data.data.find(c => c.id == id);
                                if (contactoEncontrado) {
                                    console.log('Contacto encontrado en API:', contactoEncontrado);
                                    llenarModalConDatos(contactoEncontrado);
                                    mostrarModal();
                                }
                            }
                        });
                    return; // Salir aquí para evitar ejecutar el resto
                }
                
                if (contacto) {
                    console.log('Contacto encontrado:', contacto);
                    
                    // Extraer datos del mensaje completo
                    const mensajeCompleto = contacto.mensaje || '';
                    let datosExtraidos = {
                        nombre: contacto.nombre || '-',
                        dni: contacto.dni || '-',
                        email: contacto.email || '-',
                        telefono: contacto.telefono || '-',
                        tipoConsulta: '-',
                        mensaje: '-'
                    };
                    
                    // Parsear el mensaje completo para extraer datos individuales
                    if (mensajeCompleto.includes('DATOS DEL CONTACTO:')) {
                        const lineas = mensajeCompleto.split('\n');
                        
                        lineas.forEach(linea => {
                            if (linea.includes('Nombre:')) {
                                datosExtraidos.nombre = linea.split('Nombre:')[1]?.trim() || datosExtraidos.nombre;
                            }
                            if (linea.includes('Email:')) {
                                datosExtraidos.email = linea.split('Email:')[1]?.trim() || datosExtraidos.email;
                            }
                            if (linea.includes('Teléfono:')) {
                                datosExtraidos.telefono = linea.split('Teléfono:')[1]?.trim() || datosExtraidos.telefono;
                            }
                            if (linea.includes('Tipo de consulta:')) {
                                datosExtraidos.tipoConsulta = linea.split('Tipo de consulta:')[1]?.trim() || datosExtraidos.tipoConsulta;
                            }
                        });
                        
                        // Extraer mensaje real
                        if (mensajeCompleto.includes('MENSAJE:')) {
                            const partesMensaje = mensajeCompleto.split('MENSAJE:');
                            if (partesMensaje.length > 1) {
                                datosExtraidos.mensaje = partesMensaje[1].trim();
                            }
                        }
                    }
                    
                    llenarModalConDatos(contacto);
                    mostrarModal();
                } else {
                    console.log('Contacto no encontrado localmente, buscando en API...');
                    // Búsqueda directa en API como fallback
                    fetch(`php/contactos-api.php?id=${id}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.contacto) {
                                console.log('Contacto encontrado en API:', data.contacto);
                                llenarModalConDatos(data.contacto);
                                mostrarModal();
                            } else {
                                console.log('Contacto no encontrado en API');
                                alert('No se pudo cargar la información del contacto');
                            }
                        })
                        .catch(error => {
                            console.error('Error al buscar contacto en API:', error);
                            alert('Error al cargar la información del contacto');
                        });
                }
        }
        
        function llenarModalConDatos(contacto) {
            console.log('Llenando modal con contacto:', contacto);
            
            // Extraer datos del mensaje completo
            const mensajeCompleto = contacto.mensaje || '';
            let datosExtraidos = {
                nombre: contacto.nombre || '-',
                dni: contacto.dni || '-',
                email: contacto.email || '-',
                telefono: contacto.telefono || '-',
                tipoConsulta: '-',
                mensaje: '-'
            };
            
            // Parsear el mensaje completo para extraer datos individuales
            if (mensajeCompleto.includes('DATOS DEL CONTACTO:')) {
                const lineas = mensajeCompleto.split('\n');
                
                lineas.forEach(linea => {
                    if (linea.includes('Nombre:')) {
                        datosExtraidos.nombre = linea.split('Nombre:')[1]?.trim() || datosExtraidos.nombre;
                    }
                    if (linea.includes('Email:')) {
                        datosExtraidos.email = linea.split('Email:')[1]?.trim() || datosExtraidos.email;
                    }
                    if (linea.includes('Teléfono:')) {
                        datosExtraidos.telefono = linea.split('Teléfono:')[1]?.trim() || datosExtraidos.telefono;
                    }
                    if (linea.includes('Tipo de consulta:')) {
                        datosExtraidos.tipoConsulta = linea.split('Tipo de consulta:')[1]?.trim() || datosExtraidos.tipoConsulta;
                    }
                });
                
                // Extraer mensaje real
                if (mensajeCompleto.includes('MENSAJE:')) {
                    const partesMensaje = mensajeCompleto.split('MENSAJE:');
                    if (partesMensaje.length > 1) {
                        datosExtraidos.mensaje = partesMensaje[1].trim();
                    }
                }
            }
            
            // Llenar datos del modal de asesoría con logs para debug
            console.log('Datos extraídos:', datosExtraidos);
            
            const modalMensaje = document.getElementById('modalMensaje');
            const modalNombre = document.getElementById('modalNombreAsesoria');
            const modalDni = document.getElementById('modalDniAsesoria');
            const modalCorreo = document.getElementById('modalCorreoAsesoria');
            const modalTelefono = document.getElementById('modalTelefonoAsesoria');
            const modalTipo = document.getElementById('modalTipoConsulta');
            
            console.log('Elementos encontrados:', {
                modalMensaje, modalNombre, modalDni, modalCorreo, modalTelefono, modalTipo
            });
            
            if (modalMensaje) modalMensaje.textContent = datosExtraidos.mensaje;
            if (modalNombre) modalNombre.textContent = datosExtraidos.nombre;
            if (modalDni) modalDni.textContent = datosExtraidos.dni;
            if (modalCorreo) modalCorreo.textContent = datosExtraidos.email;
            if (modalTelefono) modalTelefono.textContent = datosExtraidos.telefono;
            if (modalTipo) modalTipo.textContent = datosExtraidos.tipoConsulta;
        }
        
        function mostrarModal() {
                
                // Ocultar secciones de calificación y mostrar sección de mensaje
                const clienteInfo = document.querySelector('.cliente-info');
                const ratingDisplay = document.querySelector('.rating-display');
                const comentarioSection = document.querySelector('.comentario-section');
                const metadataSection = document.querySelector('.metadata-section');
                const mensajeSection = document.getElementById('modalMensajeSection');
                
                if (clienteInfo) clienteInfo.style.display = 'none';
                if (ratingDisplay) ratingDisplay.style.display = 'none';
                if (comentarioSection) comentarioSection.style.display = 'none';
                if (metadataSection) metadataSection.style.display = 'none';
                if (mensajeSection) mensajeSection.style.display = 'block';
                
                // Cambiar título del modal
                const modalTitle = document.querySelector('.modal-header h3');
                if (modalTitle) modalTitle.innerHTML = '<i class="fas fa-envelope"></i> Mensaje de Asesoría';
                
                // Mostrar modal con animación suave para asesoría
                const modal = document.getElementById('modalCalificacion');
                console.log('Modal encontrado:', modal);
                if (modal) {
                    // Agregar clase específica para asesoría
                    modal.classList.add('modal-asesoria');
                    modal.style.display = 'flex';
                    modal.style.opacity = '0';
                    
                    // Animación suave sin parpadeo
                    requestAnimationFrame(() => {
                        modal.style.transition = 'opacity 0.2s ease-in-out';
                        modal.style.opacity = '1';
                        modal.classList.add('active');
                        console.log('Modal activado');
                    });
                } else {
                    console.error('Modal no encontrado');
                }
            }
        }

        function deleteItem(type, id) {
            if (confirm('¿Está seguro de eliminar este elemento?')) {
                alert(`Elemento ${id} eliminado`);
            }
        }

        function contactClient(telefono, nombre) {
            if (telefono && telefono !== 'N/A') {
                const mensaje = `Hola ${nombre}, somos de Sipán Inmobiliaria. Hemos recibido tu solicitud y queremos ayudarte.`;
                const whatsappUrl = `https://wa.me/51${telefono.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(mensaje)}`;
                window.open(whatsappUrl, '_blank');
            } else {
                alert('No hay número de teléfono disponible para este cliente');
            }
        }

        // Variable global para almacenar datos completos de calificaciones
        let calificacionesCompletas = [];

        async function cargarCalificaciones() {
            try {
                const response = await fetch('../php/calificaciones-api.php?accion=todas');
                const data = await response.json();
                
                if (data.success) {
                    todasLasCalificaciones = data.data || [];
                    calificacionesCompletas = [...todasLasCalificaciones];
                    aplicarFiltros(); // Aplicar filtros por defecto
                } else {
                    console.error('Error al cargar calificaciones:', data.message);
                }
            } catch (error) {
                console.error('Error de conexión:', error);
            }
        }

        async function cargarDatosCompletosCalificaciones(calificacionesBasicas) {
            // Los datos completos ya vienen de la API actualizada
            calificacionesCompletas = calificacionesBasicas;
        }

        async function cargarEstadisticasCalificaciones() {
            try {
                const response = await fetch('../php/calificaciones-api.php?accion=estadisticas');
                const data = await response.json();
                
                if (data.success) {
                    // Actualizar tarjetas de estadísticas de calificaciones
                    document.getElementById('promedioCalificaciones').textContent = data.data.promedio_calificacion || '0.0';
                    document.getElementById('totalCalificaciones').textContent = data.data.total_calificaciones || '0';
                    
                    // Calcular porcentaje de satisfacción para mostrar como información adicional
                    const satisfaccion = data.data.porcentaje_satisfechos || '0';
                    const promedioElement = document.getElementById('promedioCalificaciones');
                    const totalElement = document.getElementById('totalCalificaciones');
                    
                    // Agregar información de satisfacción como tooltip o texto adicional
                    promedioElement.title = `${satisfaccion}% de satisfacción`;
                    totalElement.title = `${satisfaccion}% clientes satisfechos`;
                    
                } else {
                    console.error('Error al cargar estadísticas de calificaciones:', data.message);
                    // Mostrar valores por defecto en caso de error
                    document.getElementById('promedioCalificaciones').textContent = 'Error';
                    document.getElementById('totalCalificaciones').textContent = 'Error';
                }
            } catch (error) {
                console.error('Error de conexión:', error);
                // Mostrar valores por defecto en caso de error de conexión
                document.getElementById('promedioCalificaciones').textContent = 'Sin conexión';
                document.getElementById('totalCalificaciones').textContent = 'Sin conexión';
            }
        }

        // Variables para paginación de solicitudes
        let solicitudesCompletas = [];
        let solicitudesFiltradas = [];
        let paginaActualSolicitudes = 1;
        let registrosPorPaginaSolicitudes = 10;
        let contactosFiltrados = [];
        let contactoActualModal = null;
        const registrosPorPagina = 10;

        function mostrarCalificaciones(calificaciones, pagina = 1) {
            const tbody = document.getElementById('calificacionesTable');
            tbody.innerHTML = '';
            
            if (calificaciones.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay calificaciones que coincidan con los filtros</td></tr>';
                actualizarPaginacion(0, pagina);
                return;
            }
            
            // Calcular índices para la paginación
            const inicio = (pagina - 1) * registrosPorPagina;
            const fin = inicio + registrosPorPagina;
            const calificacionesPagina = calificaciones.slice(inicio, fin);
            
            calificacionesPagina.forEach((calificacion, index) => {
                const tr = document.createElement('tr');
                const estrellas = generarEstrellas(calificacion.calificacion);
                
                // Agregar clase para registros ocultos
                if (calificacion.activo == 0) {
                    tr.classList.add('registro-oculto');
                }
                
                // Calcular índice real en el array completo filtrado
                const indiceReal = inicio + index;
                
                tr.innerHTML = `
                    <td>${calificacion.fecha}</td>
                    <td>${calificacion.nombre}</td>
                    <td>
                        <div class="rating">
                            ${estrellas}
                            <span>${calificacion.calificacion}.0</span>
                        </div>
                    </td>
                    <td>${calificacion.comentario}</td>
                    <td>
                        <button class="btn-action view" onclick="mostrarDetalleCalificacion(${indiceReal})">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${calificacion.activo == 1 ? 
                            `<button class="btn-action delete" onclick="mostrarModalEliminar('calificacion', ${calificacion.id})">
                                <i class="fas fa-trash"></i>
                            </button>` : 
                            `<button class="btn-action restore" onclick="restaurarRegistro('calificacion', ${calificacion.id})" title="Restaurar registro">
                                <i class="fas fa-undo"></i>
                            </button>`
                        }
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Actualizar controles de paginación
            actualizarPaginacion(calificaciones.length, pagina);
        }

        function aplicarFiltros(resetearPagina = true) {
            const filtroOrden = document.getElementById('filtroOrden').value;
            const filtroEstrellas = document.getElementById('filtroEstrellas').value;
            const filtroEstado = document.getElementById('filtroEstado').value;
            
            calificacionesFiltradas = [...todasLasCalificaciones];
            
            // Filtrar por estrellas
            if (filtroEstrellas !== 'todas') {
                const estrellas = parseInt(filtroEstrellas);
                calificacionesFiltradas = calificacionesFiltradas.filter(cal => 
                    parseInt(cal.calificacion) === estrellas
                );
            }
            
            // Filtrar por estado
            if (filtroEstado === 'activos') {
                calificacionesFiltradas = calificacionesFiltradas.filter(cal => cal.activo == 1);
            } else if (filtroEstado === 'ocultos') {
                calificacionesFiltradas = calificacionesFiltradas.filter(cal => cal.activo == 0);
            }
            
            // Ordenar - Arreglar el problema del filtro "más antiguo"
            switch (filtroOrden) {
                case 'mas-reciente':
                    calificacionesFiltradas.sort((a, b) => {
                        const fechaA = new Date(a.fecha_completa.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1'));
                        const fechaB = new Date(b.fecha_completa.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1'));
                        return fechaB - fechaA;
                    });
                    break;
                case 'mas-antiguo':
                    calificacionesFiltradas.sort((a, b) => {
                        const fechaA = new Date(a.fecha_completa.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1'));
                        const fechaB = new Date(b.fecha_completa.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1'));
                        return fechaA - fechaB;
                    });
                    break;
                case 'mejor-valorado':
                    calificacionesFiltradas.sort((a, b) => parseInt(b.calificacion) - parseInt(a.calificacion));
                    break;
                case 'menor-valorado':
                    calificacionesFiltradas.sort((a, b) => parseInt(a.calificacion) - parseInt(b.calificacion));
                    break;
            }
            
            // Resetear a la primera página si se aplican nuevos filtros
            if (resetearPagina) {
                paginaActual = 1;
            }
            
            // Actualizar la variable global para que las funciones de detalle funcionen
            calificacionesCompletas = calificacionesFiltradas;
            mostrarCalificaciones(calificacionesFiltradas, paginaActual);
        }

        function resetearFiltros() {
            document.getElementById('filtroOrden').value = 'mas-reciente';
            document.getElementById('filtroEstrellas').value = 'todas';
            document.getElementById('filtroEstado').value = 'todos';
            aplicarFiltros();
        }

        // Funciones de paginación
        function actualizarPaginacion(totalRegistros, paginaActual) {
            const totalPaginas = Math.ceil(totalRegistros / registrosPorPagina);
            
            // Actualizar ambos contenedores de paginación
            const contenedores = ['paginacionSuperior', 'paginacionInferior'];
            
            contenedores.forEach(contenedorId => {
                const contenedor = document.getElementById(contenedorId);
                if (!contenedor) return;
                
                if (totalPaginas <= 1) {
                    contenedor.innerHTML = '';
                    return;
                }
                
                let html = '<div class="pagination-controls">';
                
                // Botón anterior
                html += `<button class="btn-pagination ${paginaActual === 1 ? 'disabled' : ''}" 
                         onclick="cambiarPagina(${paginaActual - 1})" 
                         ${paginaActual === 1 ? 'disabled' : ''}>
                         <i class="fas fa-chevron-left"></i> Anterior
                         </button>`;
                
                // Números de página
                const maxBotones = 5;
                let inicioRango = Math.max(1, paginaActual - Math.floor(maxBotones / 2));
                let finRango = Math.min(totalPaginas, inicioRango + maxBotones - 1);
                
                if (finRango - inicioRango + 1 < maxBotones) {
                    inicioRango = Math.max(1, finRango - maxBotones + 1);
                }
                
                // Primera página si no está en el rango
                if (inicioRango > 1) {
                    html += `<button class="btn-pagination-number" onclick="cambiarPagina(1)">1</button>`;
                    if (inicioRango > 2) {
                        html += '<span class="pagination-dots">...</span>';
                    }
                }
                
                // Páginas del rango
                for (let i = inicioRango; i <= finRango; i++) {
                    html += `<button class="btn-pagination-number ${i === paginaActual ? 'active' : ''}" 
                             onclick="cambiarPagina(${i})">${i}</button>`;
                }
                
                // Última página si no está en el rango
                if (finRango < totalPaginas) {
                    if (finRango < totalPaginas - 1) {
                        html += '<span class="pagination-dots">...</span>';
                    }
                    html += `<button class="btn-pagination-number" onclick="cambiarPagina(${totalPaginas})">${totalPaginas}</button>`;
                }
                
                // Botón siguiente
                html += `<button class="btn-pagination ${paginaActual === totalPaginas ? 'disabled' : ''}" 
                         onclick="cambiarPagina(${paginaActual + 1})" 
                         ${paginaActual === totalPaginas ? 'disabled' : ''}>
                         Siguiente <i class="fas fa-chevron-right"></i>
                         </button>`;
                
                html += '</div>';
                
                // Información de registros
                const inicio = (paginaActual - 1) * registrosPorPagina + 1;
                const fin = Math.min(paginaActual * registrosPorPagina, totalRegistros);
                html += `<div class="pagination-info">
                            Mostrando ${inicio} - ${fin} de ${totalRegistros} calificaciones
                         </div>`;
                
                contenedor.innerHTML = html;
            });
        }

        function cambiarPagina(nuevaPagina) {
            const totalPaginas = Math.ceil(calificacionesFiltradas.length / registrosPorPagina);
            
            if (nuevaPagina < 1 || nuevaPagina > totalPaginas) return;
            
            paginaActual = nuevaPagina;
            mostrarCalificaciones(calificacionesFiltradas, paginaActual);
        }

        function generarEstrellas(calificacion) {
            let estrellas = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= calificacion) {
                    estrellas += '<i class="fas fa-star"></i>';
                } else {
                    estrellas += '<i class="far fa-star"></i>';
                }
            }
            return estrellas;
        }

        // Variables globales para el modal de eliminación
        let tipoRegistroEliminar = '';
        let idRegistroEliminar = 0;

        function mostrarModalEliminar(tipo, id) {
            tipoRegistroEliminar = tipo;
            idRegistroEliminar = id;
            const modal = document.getElementById('modalEliminar');
            if (modal) {
                modal.style.display = 'flex';
                // Asegurar que el modal sea visible y no cause bloqueos
                modal.style.zIndex = '10001';
                modal.style.pointerEvents = 'auto';
            }
        }

        function cerrarModalEliminar() {
            document.getElementById('modalEliminar').style.display = 'none';
            tipoRegistroEliminar = '';
            idRegistroEliminar = 0;
        }

        async function restaurarRegistro(tipo, id) {
            try {
                const endpoint = tipo === 'contacto' ? '../php/contactos-api.php' : '../php/calificaciones-api.php';
                
                const response = await fetch(`${endpoint}?id=${id}&action=restaurar`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    mostrarPopupExito('Registro restaurado exitosamente', 'success');
                    
                    // Recargar datos
                    if (tipo === 'contacto') {
                        cargarContactos();
                    } else {
                        cargarCalificaciones();
                    }
                } else {
                    mostrarPopupExito('Error al restaurar: ' + data.message, 'error');
                }
                
            } catch (error) {
                console.error('Error al restaurar registro:', error);
                mostrarPopupExito('Error de conexión al restaurar', 'error');
            }
        }

        async function revertirEstado(id) {
            try {
                const response = await fetch(`../php/contactos-api.php?id=${id}&action=revertir`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    mostrarPopupExito('Estado revertido a pendiente exitosamente', 'success');
                    cargarContactos();
                    cargarEstadisticasContactos();
                } else {
                    mostrarPopupExito('Error al revertir estado: ' + data.message, 'error');
                }
                
            } catch (error) {
                console.error('Error al revertir estado:', error);
                mostrarPopupExito('Error de conexión al revertir estado', 'error');
            }
        }

        async function eliminarRegistro(tipoEliminacion) {
            try {
                const endpoint = tipoRegistroEliminar === 'contacto' ? '../php/contactos-api.php' : '../php/calificaciones-api.php';
                const action = tipoEliminacion === 'logica' ? 'ocultar' : 'eliminar';
                
                const response = await fetch(`${endpoint}?id=${idRegistroEliminar}&action=${action}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    mostrarPopupExito(
                        tipoEliminacion === 'logica' ? 
                        'Registro ocultado exitosamente' : 
                        'Registro eliminado permanentemente', 
                        'success'
                    );
                    
                    // Recargar datos
                    if (tipoRegistroEliminar === 'contacto') {
                        cargarContactos();
                        cargarEstadisticasContactos();
                    } else {
                        cargarCalificaciones();
                        cargarEstadisticasCalificaciones();
                    }
                    
                    cerrarModalEliminar();
                } else {
                    mostrarPopupExito('Error al procesar la eliminación: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error al eliminar registro:', error);
                mostrarPopupExito('Error de conexión al eliminar el registro', 'error');
            }
        }

        async function markComplete(id) {
            // Agregar animación al botón
            const btn = event.target.closest('.check-btn');
            if (btn) {
                btn.classList.add('checking');
                btn.style.transform = 'scale(0.9)';
                btn.style.transition = 'all 0.3s ease';
            }

            try {
                const response = await fetch(`../php/contactos-api.php?id=${id}&action=estado`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ estado: 'atendido' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Animación de éxito
                    if (btn) {
                        btn.style.transform = 'scale(1.1)';
                        btn.style.backgroundColor = '#28a745';
                        setTimeout(() => {
                            btn.style.transform = 'scale(1)';
                        }, 200);
                    }
                    
                    mostrarPopupExito('Solicitud marcada como atendida', 'success');
                    cargarContactos();
                    cargarEstadisticasContactos();
                } else {
                    // Restaurar botón en caso de error
                    if (btn) {
                        btn.style.transform = 'scale(1)';
                        btn.classList.remove('checking');
                    }
                    mostrarPopupExito('Error al actualizar el estado: ' + data.error, 'error');
                }
            } catch (error) {
                // Restaurar botón en caso de error
                if (btn) {
                    btn.style.transform = 'scale(1)';
                    btn.classList.remove('checking');
                }
                mostrarPopupExito('Error de conexión: ' + error.message, 'error');
            }
        }

        // Funciones para el modal de calificaciones
        function mostrarDetalleCalificacion(index) {
            const calificacion = calificacionesCompletas[index];
            if (!calificacion) return;

            // Restaurar vista de calificación (mostrar todas las secciones)
            document.querySelector('.cliente-info').style.display = 'flex';
            document.querySelector('.rating-display').style.display = 'block';
            document.querySelector('.comentario-section').style.display = 'block';
            document.querySelector('.metadata-section').style.display = 'block';
            document.getElementById('modalMensajeSection').style.display = 'none';
            
            // Restaurar título del modal
            document.querySelector('.modal-header h3').innerHTML = '<i class="fas fa-star"></i> Detalles de la Calificación';

            // Llenar datos del modal
            document.getElementById('modalNombreCliente').textContent = calificacion.nombre;
            document.getElementById('modalEmailCliente').textContent = calificacion.email;
            document.getElementById('modalFechaCalificacion').textContent = calificacion.fecha;
            document.getElementById('modalNumeroCalificacion').textContent = calificacion.calificacion + '.0';
            document.getElementById('modalComentario').textContent = calificacion.comentario;
            document.getElementById('modalIP').textContent = calificacion.ip_address;
            document.getElementById('modalFechaCompleta').textContent = calificacion.fecha_completa;

            // Generar estrellas para el modal
            const estrellasModal = generarEstrellas(calificacion.calificacion);
            document.getElementById('modalEstrellas').innerHTML = estrellasModal;

            // Mostrar modal
            document.getElementById('modalCalificacion').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('modalCalificacion').classList.add('active');
            }, 10);
        }

        function cerrarModal() {
            const modal = document.getElementById('modalCalificacion');
            
            // Animación suave para cerrar solo si es modal de asesoría
            if (modal.classList.contains('modal-asesoria')) {
                modal.style.transition = 'opacity 0.2s ease-in-out';
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                    modal.classList.remove('active', 'modal-asesoria');
                    modal.style.transition = '';
                    modal.style.opacity = '';
                }, 200);
            } else {
                // Comportamiento original para modal de calificaciones
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
        }


        // Cerrar modal al hacer clic fuera de él
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modalCalificacion');
            if (event.target === modal) {
                cerrarModal();
            }
        });

        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                cerrarModal();
            }
        });

        // Funciones de exportación a Excel
        function exportarCalificacionesExcel() {
            if (calificacionesCompletas.length === 0) {
                mostrarPopupExito('No hay calificaciones para exportar', 'info');
                return;
            }

            const btn = event.target.closest('.btn-export');
            
            try {
                // Mostrar estado de carga
                btn.classList.add('loading');
                btn.querySelector('i').className = 'fas fa-spinner fa-spin';
                btn.querySelector('span').textContent = 'Exportando...';

                // Crear tabla Excel con formato inline profesional
                let tabla = '\uFEFF'; // BOM para UTF-8
                
                // Obtener fecha actual para el reporte
                const fechaReporte = new Date().toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Calcular estadísticas
                const totalCalificaciones = calificacionesCompletas.length;
                const promedioCalificacion = (calificacionesCompletas.reduce((sum, cal) => sum + parseInt(cal.calificacion), 0) / totalCalificaciones).toFixed(1);
                const calificacionesExcelentes = calificacionesCompletas.filter(cal => parseInt(cal.calificacion) >= 4).length;
                const porcentajeSatisfaccion = Math.round((calificacionesExcelentes / totalCalificaciones) * 100);
                
                // Encabezado del reporte
                tabla += `
                    <div style="text-align: center; margin-bottom: 30px; font-family: Arial, sans-serif;">
                        <h1 style="font-size: 20px; font-weight: bold; color: #0c3c61; margin: 10px 0;">CORPORACIÓN INMOBILIARIA SIPÁN</h1>
                        <h2 style="font-size: 16px; color: #1e7bbf; margin: 5px 0;">REPORTE DE CALIFICACIONES Y EXPERIENCIAS</h2>
                        <p style="font-size: 12px; color: #666; margin: 5px 0;">Generado el ${fechaReporte}</p>
                    </div>
                    
                    <div style="background-color: #f8f9fa; padding: 15px; margin-bottom: 20px; border-left: 4px solid #1e7bbf; font-family: Arial, sans-serif;">
                        <strong>Resumen de Calificaciones:</strong><br>
                        • Total de calificaciones: ${totalCalificaciones}<br>
                        • Calificación promedio: ${promedioCalificacion}/5.0 estrellas<br>
                        • Calificaciones excelentes (4-5 estrellas): ${calificacionesExcelentes}<br>
                        • Porcentaje de satisfacción: ${porcentajeSatisfaccion}%
                    </div>
                    
                    <table border="1" style="border-collapse: collapse; width: 100%; font-family: Arial, sans-serif;">
                        <thead>
                            <tr>
                                <th style="background-color: #0c3c61; color: white; font-weight: bold; padding: 12px 8px; text-align: center; font-size: 11px;">Fecha</th>
                                <th style="background-color: #0c3c61; color: white; font-weight: bold; padding: 12px 8px; text-align: center; font-size: 11px;">Cliente</th>
                                <th style="background-color: #0c3c61; color: white; font-weight: bold; padding: 12px 8px; text-align: center; font-size: 11px;">Email</th>
                                <th style="background-color: #0c3c61; color: white; font-weight: bold; padding: 12px 8px; text-align: center; font-size: 11px;">Calificación</th>
                                <th style="background-color: #0c3c61; color: white; font-weight: bold; padding: 12px 8px; text-align: center; font-size: 11px;">Nivel Satisfacción</th>
                                <th style="background-color: #0c3c61; color: white; font-weight: bold; padding: 12px 8px; text-align: center; font-size: 11px;">Comentario</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                calificacionesCompletas.forEach((cal, index) => {
                    // Limpiar y formatear datos
                    const fecha = (cal.fecha || '').toString().replace(/"/g, '""');
                    const nombre = (cal.nombre || '').toString().replace(/"/g, '""');
                    const email = (cal.email || '').toString().replace(/"/g, '""');
                    const calificacion = parseInt(cal.calificacion) || 0;
                    const comentario = (cal.comentario || 'Sin comentario').toString().replace(/"/g, '""');
                    
                    // Determinar nivel de satisfacción y colores
                    let nivelSatisfaccion = '';
                    let satisfaccionStyle = '';
                    let estrellasTexto = '';
                    
                    // Generar estrellas en texto
                    for (let i = 1; i <= 5; i++) {
                        estrellasTexto += i <= calificacion ? '★' : '☆';
                    }
                    
                    if (calificacion >= 5) {
                        nivelSatisfaccion = '🌟 EXCELENTE';
                        satisfaccionStyle = 'background-color: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-weight: bold;';
                    } else if (calificacion >= 4) {
                        nivelSatisfaccion = '😊 MUY BUENO';
                        satisfaccionStyle = 'background-color: #cce5ff; color: #004085; padding: 4px 8px; border-radius: 4px; font-weight: bold;';
                    } else if (calificacion >= 3) {
                        nivelSatisfaccion = '😐 REGULAR';
                        satisfaccionStyle = 'background-color: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; font-weight: bold;';
                    } else {
                        nivelSatisfaccion = '😞 NECESITA MEJORAR';
                        satisfaccionStyle = 'background-color: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 4px; font-weight: bold;';
                    }
                    
                    // Determinar estilos de fila
                    const filaStyle = index % 2 === 0 ? 'background-color: #ffffff;' : 'background-color: #f8f9fa;';
                    
                    // Limitar comentario
                    let comentarioLimpio = comentario;
                    if (comentarioLimpio.length > 150) {
                        comentarioLimpio = comentarioLimpio.substring(0, 150) + '...';
                    }
                    
                    tabla += `
                        <tr style="${filaStyle}">
                            <td style="padding: 10px 8px; border: 1px solid #e1e5e9; text-align: center; font-weight: 600;">${fecha}</td>
                            <td style="padding: 10px 8px; border: 1px solid #e1e5e9; font-weight: bold; color: #0c3c61;">${nombre}</td>
                            <td style="padding: 10px 8px; border: 1px solid #e1e5e9; color: #1e7bbf;">${email}</td>
                            <td style="padding: 10px 8px; border: 1px solid #e1e5e9; text-align: center; font-weight: bold; color: #ff6b35;">${estrellasTexto} (${calificacion}.0)</td>
                            <td style="padding: 10px 8px; border: 1px solid #e1e5e9; text-align: center;"><span style="${satisfaccionStyle}">${nivelSatisfaccion}</span></td>
                            <td style="padding: 10px 8px; border: 1px solid #e1e5e9; word-wrap: break-word; max-width: 300px; line-height: 1.4;">${comentarioLimpio}</td>
                        </tr>
                    `;
                });

                tabla += `
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px; text-align: center; font-family: Arial, sans-serif;">
                        <hr style="border: 1px solid #e1e5e9; margin: 20px 0;">
                        <p style="font-weight: bold; color: #0c3c61; margin: 10px 0;">Corporación Inmobiliaria Sipán</p>
                        <p style="font-size: 12px; color: #666; margin: 5px 0;">Contacto: +51 932 359 551 | C.C Boulevard, Oficina J-3, Chiclayo - Lambayeque</p>
                        <p style="font-size: 12px; color: #666; margin: 5px 0;">Comprometidos con la excelencia en el servicio inmobiliario</p>
                        <p style="margin-top: 15px; font-style: italic; font-size: 10px; color: #999;">Reporte generado automáticamente desde el sistema administrativo</p>
                    </div>
                `;

                // Crear archivo y descargar
                const ahora = new Date();
                const fecha = ahora.toLocaleDateString('es-ES').replace(/\//g, '-');
                const hora = ahora.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}).replace(/:/g, '-');
                const filename = `Calificaciones_Sipan_${fecha}_${hora}.xls`;
                
                const blob = new Blob([tabla], {
                    type: 'application/vnd.ms-excel;charset=utf-8;'
                });
                
                const link = document.createElement('a');
                if (window.navigator.msSaveOrOpenBlob) {
                    // Para Internet Explorer
                    window.navigator.msSaveOrOpenBlob(blob, filename);
                } else {
                    // Para otros navegadores
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                }

                // Mostrar mensaje de éxito
                mostrarPopupExito(`Archivo exportado exitosamente: ${filename}`, 'success');
                
            } catch (error) {
                console.error('Error al exportar calificaciones:', error);
                mostrarPopupExito(`Error al exportar los datos: ${error.message}`, 'error');
            } finally {
                // Restaurar botón siempre
                setTimeout(() => {
                    btn.classList.remove('loading');
                    btn.querySelector('i').className = 'fas fa-file-excel';
                    btn.querySelector('span').textContent = 'Exportar a Excel';
                }, 1000);
            }
        }

        function exportarContactosExcel() {
            const btn = event.target.closest('.btn-export');
            
            try {
                // Mostrar estado de carga
                btn.classList.add('loading');
                btn.querySelector('i').className = 'fas fa-spinner fa-spin';
                btn.querySelector('span').textContent = 'Exportando...';

                // Obtener datos actuales de contactos
                fetch('../php/contactos-api.php?action=contactos')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!data.success) {
                            throw new Error(data.error || 'Error desconocido al obtener datos');
                        }
                
                if (!data.data || data.data.length === 0) {
                    mostrarPopupExito('No hay solicitudes de asesoría para exportar', 'info');
                    return;
                }

                        // Crear tabla Excel con formato inline (sin CSS externo)
                        let tabla = '\uFEFF'; // BOM para UTF-8
                        
                        // Obtener fecha actual para el reporte
                        const fechaReporte = new Date().toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        
                        // Encabezado del reporte
                        tabla += `
                            <div style="text-align: center; margin-bottom: 30px; font-family: Arial, sans-serif;">
                                <h1 style="font-size: 20px; font-weight: bold; color: #0c3c61; margin: 10px 0;">CORPORACIÓN INMOBILIARIA SIPÁN</h1>
                                <h2 style="font-size: 16px; color: #1e7bbf; margin: 5px 0;">REPORTE DE SOLICITUDES DE ASESORÍA</h2>
                                <p style="font-size: 12px; color: #666; margin: 5px 0;">Generado el ${fechaReporte}</p>
                            </div>
                            
                            <div style="background-color: #f8f9fa; padding: 15px; margin-bottom: 20px; border-left: 4px solid #1e7bbf; font-family: Arial, sans-serif;">
                                <strong>Resumen del Reporte:</strong><br>
                                • Total de solicitudes: ${data.data.length}<br>
                                • Solicitudes pendientes: ${data.data.filter(c => c.estado === 'pendiente').length}<br>
                                • Solicitudes atendidas: ${data.data.filter(c => c.estado === 'atendido').length}<br>
                                • Tasa de atención: ${Math.round((data.data.filter(c => c.estado === 'atendido').length / data.data.length) * 100)}%
                            </div>
                            
                            <table border="1" style="border-collapse: collapse; width: 100%; font-family: Arial, sans-serif;">
                                <thead>
                                    <tr>
                                        <th style="background-color: #0c3c61; color: white; font-weight: bold; padding: 12px 8px; text-align: center; font-size: 11px;">Fecha</th>
                                        <th style="background-color: #0c3c61; color: white; font-weight: bold; padding: 12px 8px; text-align: center; font-size: 11px;">Cliente</th>
                                        <th style="background-color: #0c3c61; color: white; font-weight: bold; padding: 12px 8px; text-align: center; font-size: 11px;">Email</th>
                                        <th style="background-color: #0c3c61; color: white; font-weight: bold; padding: 12px 8px; text-align: center; font-size: 11px;">Teléfono</th>
                                        <th style="background-color: #0c3c61; color: white; font-weight: bold; padding: 12px 8px; text-align: center; font-size: 11px;">Tipo Consulta</th>
                                        <th style="background-color: #0c3c61; color: white; font-weight: bold; padding: 12px 8px; text-align: center; font-size: 11px;">Estado</th>
                                        <th style="background-color: #0c3c61; color: white; font-weight: bold; padding: 12px 8px; text-align: center; font-size: 11px;">Mensaje</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        data.data.forEach(contacto => {
                            // Limpiar y formatear datos
                            const fecha = (contacto.fecha_formateada || '').toString().replace(/"/g, '""');
                            const nombre = (contacto.nombre || '').toString().replace(/"/g, '""');
                            const email = (contacto.email || '').toString().replace(/"/g, '""');
                            const telefono = (contacto.telefono || 'N/A').toString().replace(/"/g, '""');
                            const estado = (contacto.estado || 'pendiente').toString().replace(/"/g, '""');
                            const estadoClass = estado === 'pendiente' ? 'pendiente' : 'atendido';
                            const estadoTexto = estado === 'pendiente' ? '⏳ PENDIENTE' : '✅ ATENDIDO';
                            
                            // Extraer solo el mensaje limpio del cliente
                            let mensajeCompleto = (contacto.mensaje || 'Sin mensaje').toString();
                            let mensajeLimpio = 'Sin mensaje específico';
                            let tipoConsulta = 'General';
                            
                            // Extraer el mensaje real del cliente
                            const mensajeMatch = mensajeCompleto.match(/MENSAJE:\s*(.+?)(?:\s*$)/i);
                            if (mensajeMatch && mensajeMatch[1]) {
                                mensajeLimpio = mensajeMatch[1].trim();
                            } else if (!mensajeCompleto.includes('DATOS DEL CONTACTO:')) {
                                mensajeLimpio = mensajeCompleto.trim();
                            }
                            
                            // Determinar tipo de consulta basado en palabras clave
                            const mensajeParaAnalisis = mensajeLimpio.toLowerCase();
                            if (mensajeParaAnalisis.includes('dominio') || mensajeParaAnalisis.includes('media luna')) {
                                tipoConsulta = '🏘️ Dominio Media Luna';
                            } else if (mensajeParaAnalisis.includes('informacion') || mensajeParaAnalisis.includes('información')) {
                                tipoConsulta = 'ℹ️ Información General';
                            } else if (mensajeParaAnalisis.includes('precio') || mensajeParaAnalisis.includes('costo')) {
                                tipoConsulta = '💰 Consulta de Precios';
                            } else if (mensajeParaAnalisis.includes('visita') || mensajeParaAnalisis.includes('ver')) {
                                tipoConsulta = '👁️ Solicitud de Visita';
                            } else if (mensajeParaAnalisis.includes('financiamiento') || mensajeParaAnalisis.includes('credito')) {
                                tipoConsulta = '🏦 Financiamiento';
                            } else if (mensajeParaAnalisis.includes('techo propio') || mensajeParaAnalisis.includes('mi vivienda')) {
                                tipoConsulta = '🏛️ Programa Gubernamental';
                            } else {
                                tipoConsulta = '📋 Consulta General';
                            }
                            
                            // Limpiar mensaje final
                            mensajeLimpio = mensajeLimpio.replace(/"/g, '""');
                            if (mensajeLimpio.length > 200) {
                                mensajeLimpio = mensajeLimpio.substring(0, 200) + '...';
                            }
                            
                            // Determinar estilos de fila
                            const filaStyle = data.data.indexOf(contacto) % 2 === 0 ? 'background-color: #ffffff;' : 'background-color: #f8f9fa;';
                            const estadoStyle = estado === 'pendiente' ? 
                                'background-color: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; font-weight: bold;' : 
                                'background-color: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-weight: bold;';
                            
                            tabla += `
                                <tr style="${filaStyle}">
                                    <td style="padding: 10px 8px; border: 1px solid #e1e5e9; text-align: center; font-weight: 600;">${fecha}</td>
                                    <td style="padding: 10px 8px; border: 1px solid #e1e5e9; font-weight: bold; color: #0c3c61;">${nombre}</td>
                                    <td style="padding: 10px 8px; border: 1px solid #e1e5e9; color: #1e7bbf;">${email}</td>
                                    <td style="padding: 10px 8px; border: 1px solid #e1e5e9; text-align: center; font-weight: 600;">${telefono}</td>
                                    <td style="padding: 10px 8px; border: 1px solid #e1e5e9; text-align: center; font-weight: 600;">${tipoConsulta}</td>
                                    <td style="padding: 10px 8px; border: 1px solid #e1e5e9; text-align: center;"><span style="${estadoStyle}">${estadoTexto}</span></td>
                                    <td style="padding: 10px 8px; border: 1px solid #e1e5e9; word-wrap: break-word; max-width: 300px;">${mensajeLimpio}</td>
                                </tr>
                            `;
                        });

                        tabla += `
                                </tbody>
                            </table>
                            
                            <div style="margin-top: 30px; text-align: center; font-family: Arial, sans-serif;">
                                <hr style="border: 1px solid #e1e5e9; margin: 20px 0;">
                                <p style="font-weight: bold; color: #0c3c61; margin: 10px 0;">Corporación Inmobiliaria Sipán</p>
                                <p style="font-size: 12px; color: #666; margin: 5px 0;">Contacto: +51 932 359 551 | C.C Boulevard, Oficina J-3, Chiclayo - Lambayeque</p>
                                <p style="font-size: 12px; color: #666; margin: 5px 0;">Especialistas en programas Mi Vivienda y Techo Propio</p>
                                <p style="margin-top: 15px; font-style: italic; font-size: 10px; color: #999;">Reporte generado automáticamente desde el sistema administrativo</p>
                            </div>
                        `;

                        // Crear archivo y descargar
                        const ahora = new Date();
                        const fecha = ahora.toLocaleDateString('es-ES').replace(/\//g, '-');
                        const hora = ahora.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}).replace(/:/g, '-');
                        const filename = `Solicitudes_Asesoria_Sipan_${fecha}_${hora}.xls`;
                        
                        const blob = new Blob([tabla], {
                            type: 'application/vnd.ms-excel;charset=utf-8;'
                        });
                        
                        const link = document.createElement('a');
                        if (window.navigator.msSaveOrOpenBlob) {
                            // Para Internet Explorer
                            window.navigator.msSaveOrOpenBlob(blob, filename);
                        } else {
                            // Para otros navegadores
                            link.href = URL.createObjectURL(blob);
                            link.download = filename;
                            link.style.display = 'none';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(link.href);
                        }

                        // Mostrar mensaje de éxito
                        mostrarPopupExito(`Archivo exportado exitosamente: ${filename}`, 'success');
                    })
                    .catch(error => {
                        console.error('Error completo:', error);
                        mostrarPopupExito(`Error al exportar los datos: ${error.message}`, 'error');
                    })
                    .finally(() => {
                        // Restaurar botón siempre
                        setTimeout(() => {
                            btn.classList.remove('loading');
                            btn.querySelector('i').className = 'fas fa-file-excel';
                            btn.querySelector('span').textContent = 'Exportar a Excel';
                        }, 1000);
                    });
                    
            } catch (error) {
                console.error('Error inicial:', error);
                mostrarPopupExito(`Error inesperado: ${error.message}`, 'error');
                
                // Restaurar botón en caso de error inicial
                btn.classList.remove('loading');
                btn.querySelector('i').className = 'fas fa-file-excel';
                btn.querySelector('span').textContent = 'Exportar a Excel';
            }
        }

        // Función para mostrar pop-up de éxito animado
        function mostrarPopupExito(mensaje, tipo = 'success') {
            const popup = document.getElementById('successPopup');
            const messageElement = document.getElementById('successMessage');
            const iconElement = popup.querySelector('.success-icon i');
            const titleElement = popup.querySelector('.success-title');
            
            // Configurar contenido según el tipo
            if (tipo === 'success') {
                iconElement.className = 'fas fa-check-circle';
                titleElement.textContent = '¡Exportación Exitosa!';
                popup.className = 'success-popup success-type';
            } else if (tipo === 'error') {
                iconElement.className = 'fas fa-exclamation-circle';
                titleElement.textContent = '¡Error en la Exportación!';
                popup.className = 'success-popup error-type';
            } else if (tipo === 'info') {
                iconElement.className = 'fas fa-info-circle';
                titleElement.textContent = 'Información';
                popup.className = 'success-popup info-type';
            }
            
            messageElement.textContent = mensaje;
            
            // Mostrar popup con animación
            popup.style.display = 'flex';
            setTimeout(() => {
                popup.classList.add('show');
            }, 10);
            
            // Ocultar automáticamente después de 1.5 segundos
            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 300);
            }, 1500);
        }
    </script>
</body>
</html>
